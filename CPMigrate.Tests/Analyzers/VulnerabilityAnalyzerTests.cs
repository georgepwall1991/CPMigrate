using CPMigrate.Analyzers;
using CPMigrate.Models;
using FluentAssertions;
using Xunit;

namespace CPMigrate.Tests.Analyzers;

public class VulnerabilityAnalyzerTests
{
    [Fact]
    public void Analyze_VulnerabilitiesFound_ReturnsIssues()
    {
        // Arrange
        var analyzer = new VulnerabilityAnalyzer();
        var vulnerabilities = new List<VulnerabilityInfo>
        {
            new VulnerabilityInfo("System.Text.Json", "High", "GHSA-xxxx", "8.0.0", "8.0.4", "Proj1"),
            new VulnerabilityInfo("Newtonsoft.Json", "Critical", "GHSA-yyyy", "12.0.1", "13.0.1", "Proj2")
        };
        var packageInfo = new ProjectPackageInfo(new List<PackageReference>(), vulnerabilities);

        // Act
        var result = analyzer.Analyze(packageInfo);

        // Assert
        result.HasIssues.Should().BeTrue();
        result.Issues.Should().HaveCount(2);
        result.Issues.Any(i => i.PackageName == "Newtonsoft.Json" && i.Description.Contains("Critical")).Should().BeTrue();
    }

    [Fact]
    public void Analyze_NoVulnerabilities_ReturnsNoIssues()
    {
        // Arrange
        var analyzer = new VulnerabilityAnalyzer();
        var packageInfo = new ProjectPackageInfo(new List<PackageReference>(), new List<VulnerabilityInfo>());

        // Act
        var result = analyzer.Analyze(packageInfo);

        // Assert
        result.HasIssues.Should().BeFalse();
    }
}
