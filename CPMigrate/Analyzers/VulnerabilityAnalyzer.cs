using CPMigrate.Models;

namespace CPMigrate.Analyzers;

/// <summary>
/// Reports known security vulnerabilities in direct and transitive dependencies.
/// </summary>
public class VulnerabilityAnalyzer : IAnalyzer
{
    public string Name => "Security Vulnerabilities";

    public AnalyzerResult Analyze(ProjectPackageInfo packageInfo)
    {
        var issues = new List<AnalysisIssue>();

        if (packageInfo.Vulnerabilities == null)
        {
            return new AnalyzerResult(Name, issues);
        }

        // Group by package name
        var packageGroups = packageInfo.Vulnerabilities
            .GroupBy(v => v.PackageName, StringComparer.OrdinalIgnoreCase);

        foreach (var group in packageGroups)
        {
            var packageName = group.Key;
            var maxSeverity = group.MaxBy(v => GetSeverityScore(v.Severity))?.Severity ?? "Unknown";
            var affectedProjects = group.Select(v => v.ProjectName).Distinct().ToList();
            var fixedVersions = group.Select(v => v.FixedVersion).Where(v => !string.IsNullOrEmpty(v)).Distinct().ToList();
            
            var fixedIn = fixedVersions.Count > 0 ? $" (Fixed in: {string.Join(", ", fixedVersions)})" : "";

            issues.Add(new AnalysisIssue(
                packageName,
                $"[bold red]{maxSeverity}[/] severity vulnerability found in {affectedProjects.Count} project(s).{fixedIn}",
                affectedProjects
            ));
        }

        return new AnalyzerResult(Name, issues);
    }

    private int GetSeverityScore(string severity)
    {
        return severity.ToLowerInvariant() switch
        {
            "critical" => 4,
            "high" => 3,
            "moderate" => 2,
            "low" => 1,
            _ => 0
        };
    }
}
